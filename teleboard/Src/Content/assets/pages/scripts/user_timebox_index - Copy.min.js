$(function(){page.init()});var page={deviceId:$("#deviceId").val(),dragginData:{eventStartPoint:{},eventTargetPoint:{},overlapOccurred:!1},init:function(){return $.ajax({url:"/TimeBoxes/ReadDeviceTimeBoxes",type:"Get",data:{deviceId:page.deviceId},success:function(n){n.forEach(function(n,t){t.color=page.getChannelColor(t.Id)});page.initCalendar(page.deviceId,n);page.initClockPicker();page.handleModalOKClick();page.handleModalCancelClick();page.handleModalDeleteClick();page.handleModalRadioClick();page.highlightCurrentTime()}})},initClockPicker:function(){$(".clockpicker").clockpicker({donetext:teleboard.strings.ok,autoclose:!0,afterDone:function(){teleboard.ui.IsEnglish()==!1&&($("#fromTime").val(persianNumberParser.parse($("#fromTime").val())),$("#toTime").val(persianNumberParser.parse($("#toTime").val())))}})},handleModalRadioClick:function(){$('input[name="selectedChannel"]').click(function(){var n=$(this),t=n.attr("value");$(".selected-channel").css("background-color",page.getChannelColor(t)).text(n.data("channel-name")).parent().attr("href","/Channels/Contents/"+t)})},handleModalOKClick:function(){$(".btn-modal-ok").click(function(){var r=$(".from-time"),u=$(".to-time"),i=$("input[name=selectedChannel]:checked"),o=i.val();if(page.validateModal(r,u,i)){var t=$("#eventModal").data("event"),f=moment.utc(t.start.format("YYYY-MM-DD ")+r.val(),"YYYY-MM-DD HH:mm"),e=moment.utc(t.end.format("YYYY-MM-DD ")+u.val(),"YYYY-MM-DD HH:mm"),s=i.data("channel-name"),n=t.mode==="edit"?t:{id:Math.floor(Math.random()*1e6)};page.validateTimes(f,e,n.id)&&(n.start=f,n.end=e,n.title=s,n.color=page.getChannelColor(i.val()),n.ChannelId=o,t.mode==="add"?$("#calendar").fullCalendar("renderEvent",n,!0):$("#calendar").fullCalendar("updateEvent",n),page.SaveData().done(function(){$("#eventModal").modal("hide")}))}})},handleModalCancelClick:function(){$(".btn-modal-cancel").click(function(){$("#eventModal").modal("hide")})},handleModalDeleteClick:function(){$(".btn-modal-delete").click(function(){var n=$("#eventModal").data("event");if(n.mode==="add"){$("#eventModal").modal("hide");return}$("#calendar").fullCalendar("removeEvents",n.id);page.SaveData().done(function(){$("#eventModal").modal("hide")})})},getChannelColor:function(n){var t=["aqua","lightcoral","grey","fuchsia","green","lime","mediumaquamarine","crimson","olive","orange","rebeccapurple","lightblue","silver","teal","yellow"];return t[n%t.length]},initCalendar:function(n,t){$("#calendar").fullCalendar({header:{left:"",right:"agendaWeek,agendaDay"},navLinks:!0,locale:teleboard.ui.IsEnglish()?"en":"fa",snapDuration:"00:01:00",aspectRatio:1,scrollTime:"12:00 AM",editable:!0,defaultView:"agendaWeek",firstDay:teleboard.ui.IsEnglish()?0:6,eventLimit:!0,columnFormat:"ddd",axisFormat:"HH:mm",selectable:!0,selectLongPressDelay:100,viewRender:function(){},eventRender:function(n,t){t.bind("click",function(){if(n.mode="edit",$("#fromTime").val(moment(n.start).format("HH:mm")),$("#toTime").val(moment(n.end).format("HH:mm")),teleboard.ui.IsEnglish()){let t="[(]YYYY/MM/DD[)]";$(".from-date-time").text(n.start.format(t));$(".to-date-time").text(n.end.format(t))}else{let t="(YYYY/MM/DD)";$(".from-date-time").text(new persianDate(n.start.toDate()).format(t));$(".to-date-time").text(new persianDate(n.end.toDate()).format(t))}$(".selected-channel").text(n.title).css("background",n.color).parent().attr("href","/Channels/Contents/"+n.ChannelId);$("input[value="+n.ChannelId+"]").prop("checked","true");$("#eventModal").data("event",n).modal("show")})},select:function(n,t,i){if($(".selected-channel").html(teleboard.strings.pleaseSelectAChannel).css("background-color","").parent().removeAttr("href"),$("input[type=radio]").prop("checked",!1),$("#fromTime").val(moment(n).format("HH:mm")),$("#toTime").val(moment(t).format("HH:mm")),teleboard.ui.IsEnglish()){let i="[(]YYYY/MM/DD[)]";$(".from-date-time").text(n.format(i));$(".to-date-time").text(t.format(i))}else{let i="(YYYY/MM/DD)";$(".from-date-time").text(new persianDate(n.toDate()).format(i));$(".to-date-time").text(new persianDate(t.toDate()).format(i))}$("#eventModal").data("event",{mode:"add",start:n,end:t,allDay:i}).modal("show")},eventDragStart:function(n){page.dragginData.eventStartPoint=n;window.navigator.vibrate(200)},eventDrop:function(n,t,i){page.dragginData.overlapOccurred==!0&&(i(),page.dragginData.eventStartPoint.start.isBefore(page.dragginData.eventTargetPoint.start)?(n.start=page.dragginData.eventStartPoint.start,n.end=page.dragginData.eventTargetPoint.start.add(-1,"seconds")):(n.start=page.dragginData.eventTargetPoint.end.add(1,"seconds"),n.end=page.dragginData.eventStartPoint.end),page.validateTimes(n.start,n.end,n.id)&&$("#calendar").fullCalendar("updateEvent",n),page.dragginData.overlapOccurred=!1);page.SaveData()},eventResize:function(){page.SaveData()},eventOverlap:function(n){return page.dragginData.eventTargetPoint=n,page.dragginData.overlapOccurred=!0,!0},selectOverlap:function(){return!1},dayClick:function(){},events:t.map(function(n){return{id:n.Id,title:n.ChannelName,start:page.normilizeDate(n.WeekDay,n.FromHour,n.FromMinute).format("YYYY[-]MM[-]DD[T]HH:mm:ss"),end:page.normilizeDate(n.WeekDay,n.ToHour,n.ToMinute).format("YYYY[-]MM[-]DD[T]HH:mm:ss"),color:page.getChannelColor(n.ChannelId),ChannelId:n.ChannelId}})});$(".fc-day").on("click",function(n){var i=$(n.target),t,r,u;i.hasClass("fc-sat")?t="saturday":i.hasClass("fc-sun")?t="sunday":i.hasClass("fc-mon")?t="monday":i.hasClass("fc-tue")?t="tuesday":i.hasClass("fc-wed")?t="wednesday":i.hasClass("fc-thu")?t="thursday":i.hasClass("fc-fri")&&(t="friday");r=page.normilizeDate(t,0,0);u=moment(r).add(1,"d");page.IsAllowedToCreateEventForDay(r)?$("#calendar").fullCalendar("select",r,u):teleboard.ui.showAlert(teleboard.strings.CanNotCreateEventForAllDay,teleboard.strings.invalidOperation,"error")})},IsAllowedToCreateEventForDay:function(n){for(var t,r=$("#calendar").fullCalendar("clientEvents"),i=0;i<r.length;i++)if(t=r[i],t.start.day()===n.day()||t.start.isBefore(n)&&t.end.isAfter(n))return!1;return!0},normilizeDate:function(n,t,i){var n=n.toLowerCase(),r,u;return teleboard.ui.IsEnglish()?moment().day(n).hour(t).minute(i).second(0):(u=moment().day()===6?moment().add(1,"d"):moment().startOf("week"),n==="saturday"?r=-1:n==="sunday"?r=0:n==="monday"?r=1:n==="tuesday"?r=2:n==="wednesday"?r=3:n==="thursday"?r=4:n==="friday"&&(r=5),u.add(r,"d").hour(t).minute(i).second(0))},validateModal:function(n,t,i){var r=moment(n.val(),"HH:mm"),u=moment(t.val(),"HH:mm");return r.isValid()?u.isValid()?typeof i.val()=="undefined"?(teleboard.ui.showAlert(teleboard.strings.pleaseSelectAChannel,"","error"),!1):!0:(teleboard.ui.showAlert(teleboard.strings.enterAValidTime,teleboard.strings.invalidTime,"error"),t.focus(),!1):(teleboard.ui.showAlert(teleboard.strings.enterAValidTime,teleboard.strings.invalidTime,"error"),n.focus(),!1)},validateTimes:function(n,t,i){var f,u,r;if(t.isBefore(n))return teleboard.ui.showAlert(teleboard.strings.endTimeIsBeforeStartTime,"","error"),!1;for(f=$("#calendar").fullCalendar("clientEvents"),u=0;u<f.length;u++)if(r=f[u],r.id!==i){if(n.isBefore(r.end)&&t.isAfter(r.end))return teleboard.ui.showAlert(teleboard.strings.eventStartTimeHasConflict,teleboard.strings.invalidStartTime,"error"),!1;if(t.isAfter(r.start)&&t.isBefore(r.end))return teleboard.ui.showAlert(teleboard.strings.eventEndTimeHasConflict,teleboard.strings.invalidEndTime,"error"),!1}return!0},highlightCurrentTime:function(){var i=new Date,n=i.getHours(),r=i.getMinutes(),f=(n>=10?n.toString():"0"+n)+":"+(r<30?"00":"30")+":00",t=$('tr[data-time="{0}"]'.replace("{0}",f)),u;t.children().eq(0).css("background-color","#f8cb00");u=$("#timeIndicator").show().css("top",r%30/30*t.height());t.children().eq(1).css("position","relative").append(u)},SaveData:function(){var n=$("#calendar").fullCalendar("clientEvents").map(function(n){var t="YYYY[-]MM[-]DD HH:mm:ss";return{Id:n.id,Start:n.start.format(t),End:n.end.format(t),ChannelId:n.ChannelId}});return $(".btn-modal").attr("disabled",""),$.ajax({url:"/TimeBoxes/SaveEvents",type:"Post",data:{deviceId:page.deviceId,events:n},beforeSend:function(){},complete:function(){$(".btn-modal").removeAttr("disabled")},success:function(n){teleboard.ui.showMessage(n.Time,teleboard.strings.saved,"success",8e3)}})},onRemoveAllSchedulings:function(){swal({title:teleboard.strings.removeAllSchedulings,text:teleboard.strings.thisOperationIsNotUndoable,type:"warning",showCancelButton:!0,confirmButtonColor:"#DD6B55",confirmButtonText:teleboard.strings.yes,cancelButtonText:teleboard.strings.no,closeOnConfirm:!1,closeOnCancel:!0},function(n){n&&$.ajax({url:"/TimeBoxes/RemoveAllSchedulings",type:"POST",data:{deviceId:page.deviceId},beforeSend:function(){$("button[class=confirm], button[class=cancel]").attr("disabled","true")},success:function(){$("#calendar").fullCalendar("removeEvents");swal.close()}})})}};